filter((count() >= 10),
  groupby([a_ca_state as state, count() as cnt],
    [a_ca_state],
    filter(((((((a_ca_address_sk = c_c_current_addr_sk) &&
               (c_c_customer_sk = s_ss_customer_sk)) &&
              (s_ss_sold_date_sk = d_d_date_sk)) &&
             (s_ss_item_sk = i_i_item_sk)) &&
            (d_d_month_seq =
            (dedup(
               select([d_d_month_seq],
                 filter(((d_d_year = YEAR_01) && (d_d_moy = MONTH_01)),
                   date_dim)))))) &&
           (i_i_current_price >
           (1.2 *
           (select([avg(j_i_current_price)],
              filter((j_i_category = i_i_category),
                select([i_item_sk as j_i_item_sk,
                        i_item_id as j_i_item_id,
                        i_rec_start_date as j_i_rec_start_date,
                        i_rec_end_date as j_i_rec_end_date,
                        i_item_desc as j_i_item_desc,
                        i_current_price as j_i_current_price,
                        i_wholesale_cost as j_i_wholesale_cost,
                        i_brand_id as j_i_brand_id,
                        i_brand as j_i_brand,
                        i_class_id as j_i_class_id,
                        i_class as j_i_class,
                        i_category_id as j_i_category_id,
                        i_category as j_i_category,
                        i_manufact_id as j_i_manufact_id,
                        i_manufact as j_i_manufact,
                        i_size as j_i_size,
                        i_formulation as j_i_formulation,
                        i_color as j_i_color,
                        i_units as j_i_units,
                        i_container as j_i_container,
                        i_manager_id as j_i_manager_id,
                        i_product_name as j_i_product_name],
                  item))))))),
      join(true,
        select([ca_address_sk as a_ca_address_sk,
                ca_address_id as a_ca_address_id,
                ca_street_number as a_ca_street_number,
                ca_street_name as a_ca_street_name,
                ca_street_type as a_ca_street_type,
                ca_suite_number as a_ca_suite_number,
                ca_city as a_ca_city,
                ca_county as a_ca_county,
                ca_state as a_ca_state,
                ca_zip as a_ca_zip,
                ca_country as a_ca_country,
                ca_gmt_offset as a_ca_gmt_offset,
                ca_location_type as a_ca_location_type],
          customer_address),
        join(true,
          select([c_customer_sk as c_c_customer_sk,
                  c_customer_id as c_c_customer_id,
                  c_current_cdemo_sk as c_c_current_cdemo_sk,
                  c_current_hdemo_sk as c_c_current_hdemo_sk,
                  c_current_addr_sk as c_c_current_addr_sk,
                  c_first_shipto_date_sk as c_c_first_shipto_date_sk,
                  c_first_sales_date_sk as c_c_first_sales_date_sk,
                  c_salutation as c_c_salutation,
                  c_first_name as c_c_first_name,
                  c_last_name as c_c_last_name,
                  c_preferred_cust_flag as c_c_preferred_cust_flag,
                  c_birth_day as c_c_birth_day,
                  c_birth_month as c_c_birth_month,
                  c_birth_year as c_c_birth_year,
                  c_birth_country as c_c_birth_country,
                  c_login as c_c_login,
                  c_email_address as c_c_email_address,
                  c_last_review_date_sk as c_c_last_review_date_sk],
            customer),
          join(true,
            select([ss_sold_date_sk as s_ss_sold_date_sk,
                    ss_sold_time_sk as s_ss_sold_time_sk,
                    ss_item_sk as s_ss_item_sk,
                    ss_customer_sk as s_ss_customer_sk,
                    ss_cdemo_sk as s_ss_cdemo_sk,
                    ss_hdemo_sk as s_ss_hdemo_sk,
                    ss_addr_sk as s_ss_addr_sk,
                    ss_store_sk as s_ss_store_sk,
                    ss_promo_sk as s_ss_promo_sk,
                    ss_ticket_number as s_ss_ticket_number,
                    ss_quantity as s_ss_quantity,
                    ss_wholesale_cost as s_ss_wholesale_cost,
                    ss_list_price as s_ss_list_price,
                    ss_sales_price as s_ss_sales_price,
                    ss_ext_discount_amt as s_ss_ext_discount_amt,
                    ss_ext_sales_price as s_ss_ext_sales_price,
                    ss_ext_wholesale_cost as s_ss_ext_wholesale_cost,
                    ss_ext_list_price as s_ss_ext_list_price,
                    ss_ext_tax as s_ss_ext_tax,
                    ss_coupon_amt as s_ss_coupon_amt,
                    ss_net_paid as s_ss_net_paid,
                    ss_net_paid_inc_tax as s_ss_net_paid_inc_tax,
                    ss_net_profit as s_ss_net_profit],
              store_sales),
            join(true,
              select([d_date_sk as d_d_date_sk,
                      d_date_id as d_d_date_id,
                      d_date as d_d_date,
                      d_month_seq as d_d_month_seq,
                      d_week_seq as d_d_week_seq,
                      d_quarter_seq as d_d_quarter_seq,
                      d_year as d_d_year,
                      d_dow as d_d_dow,
                      d_moy as d_d_moy,
                      d_dom as d_d_dom,
                      d_qoy as d_d_qoy,
                      d_fy_year as d_d_fy_year,
                      d_fy_quarter_seq as d_d_fy_quarter_seq,
                      d_fy_week_seq as d_d_fy_week_seq,
                      d_day_name as d_d_day_name,
                      d_quarter_name as d_d_quarter_name,
                      d_holiday as d_d_holiday,
                      d_weekend as d_d_weekend,
                      d_following_holiday as d_d_following_holiday,
                      d_first_dom as d_d_first_dom,
                      d_last_dom as d_d_last_dom,
                      d_same_day_ly as d_d_same_day_ly,
                      d_same_day_lq as d_d_same_day_lq,
                      d_current_day as d_d_current_day,
                      d_current_week as d_d_current_week,
                      d_current_month as d_d_current_month,
                      d_current_quarter as d_d_current_quarter,
                      d_current_year as d_d_current_year],
                date_dim),
              select([i_item_sk as i_i_item_sk,
                      i_item_id as i_i_item_id,
                      i_rec_start_date as i_i_rec_start_date,
                      i_rec_end_date as i_i_rec_end_date,
                      i_item_desc as i_i_item_desc,
                      i_current_price as i_i_current_price,
                      i_wholesale_cost as i_i_wholesale_cost,
                      i_brand_id as i_i_brand_id,
                      i_brand as i_i_brand,
                      i_class_id as i_i_class_id,
                      i_class as i_i_class,
                      i_category_id as i_i_category_id,
                      i_category as i_i_category,
                      i_manufact_id as i_i_manufact_id,
                      i_manufact as i_i_manufact,
                      i_size as i_i_size,
                      i_formulation as i_i_formulation,
                      i_color as i_i_color,
                      i_units as i_i_units,
                      i_container as i_i_container,
                      i_manager_id as i_i_manager_id,
                      i_product_name as i_i_product_name],
                item))))))))

