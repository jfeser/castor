select([t_s_secyear_customer_id,
        t_s_secyear_customer_first_name,
        t_s_secyear_customer_last_name,
        t_s_secyear_customer_preferred_cust_flag],
  filter(((((((((((((((((((((((t_s_secyear_customer_id =
                              t_s_firstyear_customer_id) &&
                             (t_s_firstyear_customer_id =
                             t_c_secyear_customer_id)) &&
                            (t_s_firstyear_customer_id =
                            t_c_firstyear_customer_id)) &&
                           (t_s_firstyear_customer_id =
                           t_w_firstyear_customer_id)) &&
                          (t_s_firstyear_customer_id =
                          t_w_secyear_customer_id)) &&
                         (t_s_firstyear_sale_type = "s")) &&
                        (t_c_firstyear_sale_type = "c")) &&
                       (t_w_firstyear_sale_type = "w")) &&
                      (t_s_secyear_sale_type = "s")) &&
                     (t_c_secyear_sale_type = "c")) &&
                    (t_w_secyear_sale_type = "w")) &&
                   (t_s_firstyear_dyear = YEAR_01)) &&
                  (t_s_secyear_dyear = (YEAR_01 + 1))) &&
                 (t_c_firstyear_dyear = YEAR_01)) &&
                (t_c_secyear_dyear = (YEAR_01 + 1))) &&
               (t_w_firstyear_dyear = YEAR_01)) &&
              (t_w_secyear_dyear = (YEAR_01 + 1))) &&
             (t_s_firstyear_year_total > 0)) &&
            (t_c_firstyear_year_total > 0)) &&
           (t_w_firstyear_year_total > 0)) &&
          ((if (t_c_firstyear_year_total > 0) then (t_c_secyear_year_total /
                                                   t_c_firstyear_year_total) else null)
          >
          (if (t_s_firstyear_year_total > 0) then (t_s_secyear_year_total /
                                                  t_s_firstyear_year_total) else null)))
         &&
         ((if (t_c_firstyear_year_total > 0) then (t_c_secyear_year_total /
                                                  t_c_firstyear_year_total) else null)
         >
         (if (t_w_firstyear_year_total > 0) then (t_w_secyear_year_total /
                                                 t_w_firstyear_year_total) else null))),
    join(true,
      select([customer_id as t_s_firstyear_customer_id,
              customer_first_name as t_s_firstyear_customer_first_name,
              customer_last_name as t_s_firstyear_customer_last_name,
              customer_preferred_cust_flag as t_s_firstyear_customer_preferred_cust_flag,
              customer_birth_country as t_s_firstyear_customer_birth_country,
              customer_login as t_s_firstyear_customer_login,
              customer_email_address as t_s_firstyear_customer_email_address,
              dyear as t_s_firstyear_dyear,
              year_total as t_s_firstyear_year_total,
              sale_type as t_s_firstyear_sale_type],
        atuple([groupby([c_customer_id as customer_id,
                         c_first_name as customer_first_name,
                         c_last_name as customer_last_name,
                         c_preferred_cust_flag as customer_preferred_cust_flag,
                         c_birth_country as customer_birth_country,
                         c_login as customer_login,
                         c_email_address as customer_email_address,
                         d_year as dyear,
                         sum(((((ss_ext_list_price - ss_ext_wholesale_cost) -
                               ss_ext_discount_amt) + ss_ext_sales_price) /
                             2)) as year_total,
                         "s" as sale_type],
                  [c_customer_id,
                   c_first_name,
                   c_last_name,
                   c_preferred_cust_flag,
                   c_birth_country,
                   c_login,
                   c_email_address,
                   d_year],
                  filter(((c_customer_sk = ss_customer_sk) &&
                         (ss_sold_date_sk = d_date_sk)),
                    join(true, customer, join(true, store_sales, date_dim)))),
                atuple([groupby([c_customer_id as customer_id,
                                 c_first_name as customer_first_name,
                                 c_last_name as customer_last_name,
                                 c_preferred_cust_flag as customer_preferred_cust_flag,
                                 c_birth_country as customer_birth_country,
                                 c_login as customer_login,
                                 c_email_address as customer_email_address,
                                 d_year as dyear,
                                 sum(((((cs_ext_list_price -
                                        cs_ext_wholesale_cost) -
                                       cs_ext_discount_amt) +
                                      cs_ext_sales_price) / 2)) as year_total,
                                 "c" as sale_type],
                          [c_customer_id,
                           c_first_name,
                           c_last_name,
                           c_preferred_cust_flag,
                           c_birth_country,
                           c_login,
                           c_email_address,
                           d_year],
                          filter(((c_customer_sk = cs_bill_customer_sk) &&
                                 (cs_sold_date_sk = d_date_sk)),
                            join(true,
                              customer,
                              join(true, catalog_sales, date_dim)))),
                        groupby([c_customer_id as customer_id,
                                 c_first_name as customer_first_name,
                                 c_last_name as customer_last_name,
                                 c_preferred_cust_flag as customer_preferred_cust_flag,
                                 c_birth_country as customer_birth_country,
                                 c_login as customer_login,
                                 c_email_address as customer_email_address,
                                 d_year as dyear,
                                 sum(((((ws_ext_list_price -
                                        ws_ext_wholesale_cost) -
                                       ws_ext_discount_amt) +
                                      ws_ext_sales_price) / 2)) as year_total,
                                 "w" as sale_type],
                          [c_customer_id,
                           c_first_name,
                           c_last_name,
                           c_preferred_cust_flag,
                           c_birth_country,
                           c_login,
                           c_email_address,
                           d_year],
                          filter(((c_customer_sk = ws_bill_customer_sk) &&
                                 (ws_sold_date_sk = d_date_sk)),
                            join(true,
                              customer,
                              join(true, web_sales, date_dim))))],
                  concat)],
          concat)),
      join(true,
        select([customer_id as t_s_secyear_customer_id,
                customer_first_name as t_s_secyear_customer_first_name,
                customer_last_name as t_s_secyear_customer_last_name,
                customer_preferred_cust_flag as t_s_secyear_customer_preferred_cust_flag,
                customer_birth_country as t_s_secyear_customer_birth_country,
                customer_login as t_s_secyear_customer_login,
                customer_email_address as t_s_secyear_customer_email_address,
                dyear as t_s_secyear_dyear,
                year_total as t_s_secyear_year_total,
                sale_type as t_s_secyear_sale_type],
          atuple([groupby([c_customer_id as customer_id,
                           c_first_name as customer_first_name,
                           c_last_name as customer_last_name,
                           c_preferred_cust_flag as customer_preferred_cust_flag,
                           c_birth_country as customer_birth_country,
                           c_login as customer_login,
                           c_email_address as customer_email_address,
                           d_year as dyear,
                           sum(((((ss_ext_list_price - ss_ext_wholesale_cost)
                                 - ss_ext_discount_amt) + ss_ext_sales_price)
                               / 2)) as year_total,
                           "s" as sale_type],
                    [c_customer_id,
                     c_first_name,
                     c_last_name,
                     c_preferred_cust_flag,
                     c_birth_country,
                     c_login,
                     c_email_address,
                     d_year],
                    filter(((c_customer_sk = ss_customer_sk) &&
                           (ss_sold_date_sk = d_date_sk)),
                      join(true, customer, join(true, store_sales, date_dim)))),
                  atuple([groupby([c_customer_id as customer_id,
                                   c_first_name as customer_first_name,
                                   c_last_name as customer_last_name,
                                   c_preferred_cust_flag as customer_preferred_cust_flag,
                                   c_birth_country as customer_birth_country,
                                   c_login as customer_login,
                                   c_email_address as customer_email_address,
                                   d_year as dyear,
                                   sum(((((cs_ext_list_price -
                                          cs_ext_wholesale_cost) -
                                         cs_ext_discount_amt) +
                                        cs_ext_sales_price) / 2)) as year_total,
                                   "c" as sale_type],
                            [c_customer_id,
                             c_first_name,
                             c_last_name,
                             c_preferred_cust_flag,
                             c_birth_country,
                             c_login,
                             c_email_address,
                             d_year],
                            filter(((c_customer_sk = cs_bill_customer_sk) &&
                                   (cs_sold_date_sk = d_date_sk)),
                              join(true,
                                customer,
                                join(true, catalog_sales, date_dim)))),
                          groupby([c_customer_id as customer_id,
                                   c_first_name as customer_first_name,
                                   c_last_name as customer_last_name,
                                   c_preferred_cust_flag as customer_preferred_cust_flag,
                                   c_birth_country as customer_birth_country,
                                   c_login as customer_login,
                                   c_email_address as customer_email_address,
                                   d_year as dyear,
                                   sum(((((ws_ext_list_price -
                                          ws_ext_wholesale_cost) -
                                         ws_ext_discount_amt) +
                                        ws_ext_sales_price) / 2)) as year_total,
                                   "w" as sale_type],
                            [c_customer_id,
                             c_first_name,
                             c_last_name,
                             c_preferred_cust_flag,
                             c_birth_country,
                             c_login,
                             c_email_address,
                             d_year],
                            filter(((c_customer_sk = ws_bill_customer_sk) &&
                                   (ws_sold_date_sk = d_date_sk)),
                              join(true,
                                customer,
                                join(true, web_sales, date_dim))))],
                    concat)],
            concat)),
        join(true,
          select([customer_id as t_c_firstyear_customer_id,
                  customer_first_name as t_c_firstyear_customer_first_name,
                  customer_last_name as t_c_firstyear_customer_last_name,
                  customer_preferred_cust_flag as t_c_firstyear_customer_preferred_cust_flag,
                  customer_birth_country as t_c_firstyear_customer_birth_country,
                  customer_login as t_c_firstyear_customer_login,
                  customer_email_address as t_c_firstyear_customer_email_address,
                  dyear as t_c_firstyear_dyear,
                  year_total as t_c_firstyear_year_total,
                  sale_type as t_c_firstyear_sale_type],
            atuple([groupby([c_customer_id as customer_id,
                             c_first_name as customer_first_name,
                             c_last_name as customer_last_name,
                             c_preferred_cust_flag as customer_preferred_cust_flag,
                             c_birth_country as customer_birth_country,
                             c_login as customer_login,
                             c_email_address as customer_email_address,
                             d_year as dyear,
                             sum(((((ss_ext_list_price -
                                    ss_ext_wholesale_cost) -
                                   ss_ext_discount_amt) + ss_ext_sales_price)
                                 / 2)) as year_total,
                             "s" as sale_type],
                      [c_customer_id,
                       c_first_name,
                       c_last_name,
                       c_preferred_cust_flag,
                       c_birth_country,
                       c_login,
                       c_email_address,
                       d_year],
                      filter(((c_customer_sk = ss_customer_sk) &&
                             (ss_sold_date_sk = d_date_sk)),
                        join(true,
                          customer,
                          join(true, store_sales, date_dim)))),
                    atuple([groupby([c_customer_id as customer_id,
                                     c_first_name as customer_first_name,
                                     c_last_name as customer_last_name,
                                     c_preferred_cust_flag as customer_preferred_cust_flag,
                                     c_birth_country as customer_birth_country,
                                     c_login as customer_login,
                                     c_email_address as customer_email_address,
                                     d_year as dyear,
                                     sum(((((cs_ext_list_price -
                                            cs_ext_wholesale_cost) -
                                           cs_ext_discount_amt) +
                                          cs_ext_sales_price) / 2)) as year_total,
                                     "c" as sale_type],
                              [c_customer_id,
                               c_first_name,
                               c_last_name,
                               c_preferred_cust_flag,
                               c_birth_country,
                               c_login,
                               c_email_address,
                               d_year],
                              filter(((c_customer_sk = cs_bill_customer_sk)
                                     && (cs_sold_date_sk = d_date_sk)),
                                join(true,
                                  customer,
                                  join(true, catalog_sales, date_dim)))),
                            groupby([c_customer_id as customer_id,
                                     c_first_name as customer_first_name,
                                     c_last_name as customer_last_name,
                                     c_preferred_cust_flag as customer_preferred_cust_flag,
                                     c_birth_country as customer_birth_country,
                                     c_login as customer_login,
                                     c_email_address as customer_email_address,
                                     d_year as dyear,
                                     sum(((((ws_ext_list_price -
                                            ws_ext_wholesale_cost) -
                                           ws_ext_discount_amt) +
                                          ws_ext_sales_price) / 2)) as year_total,
                                     "w" as sale_type],
                              [c_customer_id,
                               c_first_name,
                               c_last_name,
                               c_preferred_cust_flag,
                               c_birth_country,
                               c_login,
                               c_email_address,
                               d_year],
                              filter(((c_customer_sk = ws_bill_customer_sk)
                                     && (ws_sold_date_sk = d_date_sk)),
                                join(true,
                                  customer,
                                  join(true, web_sales, date_dim))))],
                      concat)],
              concat)),
          join(true,
            select([customer_id as t_c_secyear_customer_id,
                    customer_first_name as t_c_secyear_customer_first_name,
                    customer_last_name as t_c_secyear_customer_last_name,
                    customer_preferred_cust_flag as t_c_secyear_customer_preferred_cust_flag,
                    customer_birth_country as t_c_secyear_customer_birth_country,
                    customer_login as t_c_secyear_customer_login,
                    customer_email_address as t_c_secyear_customer_email_address,
                    dyear as t_c_secyear_dyear,
                    year_total as t_c_secyear_year_total,
                    sale_type as t_c_secyear_sale_type],
              atuple([groupby([c_customer_id as customer_id,
                               c_first_name as customer_first_name,
                               c_last_name as customer_last_name,
                               c_preferred_cust_flag as customer_preferred_cust_flag,
                               c_birth_country as customer_birth_country,
                               c_login as customer_login,
                               c_email_address as customer_email_address,
                               d_year as dyear,
                               sum(((((ss_ext_list_price -
                                      ss_ext_wholesale_cost) -
                                     ss_ext_discount_amt) +
                                    ss_ext_sales_price) / 2)) as year_total,
                               "s" as sale_type],
                        [c_customer_id,
                         c_first_name,
                         c_last_name,
                         c_preferred_cust_flag,
                         c_birth_country,
                         c_login,
                         c_email_address,
                         d_year],
                        filter(((c_customer_sk = ss_customer_sk) &&
                               (ss_sold_date_sk = d_date_sk)),
                          join(true,
                            customer,
                            join(true, store_sales, date_dim)))),
                      atuple([groupby([c_customer_id as customer_id,
                                       c_first_name as customer_first_name,
                                       c_last_name as customer_last_name,
                                       c_preferred_cust_flag as customer_preferred_cust_flag,
                                       c_birth_country as customer_birth_country,
                                       c_login as customer_login,
                                       c_email_address as customer_email_address,
                                       d_year as dyear,
                                       sum(((((cs_ext_list_price -
                                              cs_ext_wholesale_cost) -
                                             cs_ext_discount_amt) +
                                            cs_ext_sales_price) / 2)) as year_total,
                                       "c" as sale_type],
                                [c_customer_id,
                                 c_first_name,
                                 c_last_name,
                                 c_preferred_cust_flag,
                                 c_birth_country,
                                 c_login,
                                 c_email_address,
                                 d_year],
                                filter(((c_customer_sk = cs_bill_customer_sk)
                                       && (cs_sold_date_sk = d_date_sk)),
                                  join(true,
                                    customer,
                                    join(true, catalog_sales, date_dim)))),
                              groupby([c_customer_id as customer_id,
                                       c_first_name as customer_first_name,
                                       c_last_name as customer_last_name,
                                       c_preferred_cust_flag as customer_preferred_cust_flag,
                                       c_birth_country as customer_birth_country,
                                       c_login as customer_login,
                                       c_email_address as customer_email_address,
                                       d_year as dyear,
                                       sum(((((ws_ext_list_price -
                                              ws_ext_wholesale_cost) -
                                             ws_ext_discount_amt) +
                                            ws_ext_sales_price) / 2)) as year_total,
                                       "w" as sale_type],
                                [c_customer_id,
                                 c_first_name,
                                 c_last_name,
                                 c_preferred_cust_flag,
                                 c_birth_country,
                                 c_login,
                                 c_email_address,
                                 d_year],
                                filter(((c_customer_sk = ws_bill_customer_sk)
                                       && (ws_sold_date_sk = d_date_sk)),
                                  join(true,
                                    customer,
                                    join(true, web_sales, date_dim))))],
                        concat)],
                concat)),
            join(true,
              select([customer_id as t_w_firstyear_customer_id,
                      customer_first_name as t_w_firstyear_customer_first_name,
                      customer_last_name as t_w_firstyear_customer_last_name,
                      customer_preferred_cust_flag as t_w_firstyear_customer_preferred_cust_flag,
                      customer_birth_country as t_w_firstyear_customer_birth_country,
                      customer_login as t_w_firstyear_customer_login,
                      customer_email_address as t_w_firstyear_customer_email_address,
                      dyear as t_w_firstyear_dyear,
                      year_total as t_w_firstyear_year_total,
                      sale_type as t_w_firstyear_sale_type],
                atuple([groupby([c_customer_id as customer_id,
                                 c_first_name as customer_first_name,
                                 c_last_name as customer_last_name,
                                 c_preferred_cust_flag as customer_preferred_cust_flag,
                                 c_birth_country as customer_birth_country,
                                 c_login as customer_login,
                                 c_email_address as customer_email_address,
                                 d_year as dyear,
                                 sum(((((ss_ext_list_price -
                                        ss_ext_wholesale_cost) -
                                       ss_ext_discount_amt) +
                                      ss_ext_sales_price) / 2)) as year_total,
                                 "s" as sale_type],
                          [c_customer_id,
                           c_first_name,
                           c_last_name,
                           c_preferred_cust_flag,
                           c_birth_country,
                           c_login,
                           c_email_address,
                           d_year],
                          filter(((c_customer_sk = ss_customer_sk) &&
                                 (ss_sold_date_sk = d_date_sk)),
                            join(true,
                              customer,
                              join(true, store_sales, date_dim)))),
                        atuple([groupby([c_customer_id as customer_id,
                                         c_first_name as customer_first_name,
                                         c_last_name as customer_last_name,
                                         c_preferred_cust_flag as customer_preferred_cust_flag,
                                         c_birth_country as customer_birth_country,
                                         c_login as customer_login,
                                         c_email_address as customer_email_address,
                                         d_year as dyear,
                                         sum(((((cs_ext_list_price -
                                                cs_ext_wholesale_cost) -
                                               cs_ext_discount_amt) +
                                              cs_ext_sales_price) / 2)) as year_total,
                                         "c" as sale_type],
                                  [c_customer_id,
                                   c_first_name,
                                   c_last_name,
                                   c_preferred_cust_flag,
                                   c_birth_country,
                                   c_login,
                                   c_email_address,
                                   d_year],
                                  filter(((c_customer_sk =
                                          cs_bill_customer_sk) &&
                                         (cs_sold_date_sk = d_date_sk)),
                                    join(true,
                                      customer,
                                      join(true, catalog_sales, date_dim)))),
                                groupby([c_customer_id as customer_id,
                                         c_first_name as customer_first_name,
                                         c_last_name as customer_last_name,
                                         c_preferred_cust_flag as customer_preferred_cust_flag,
                                         c_birth_country as customer_birth_country,
                                         c_login as customer_login,
                                         c_email_address as customer_email_address,
                                         d_year as dyear,
                                         sum(((((ws_ext_list_price -
                                                ws_ext_wholesale_cost) -
                                               ws_ext_discount_amt) +
                                              ws_ext_sales_price) / 2)) as year_total,
                                         "w" as sale_type],
                                  [c_customer_id,
                                   c_first_name,
                                   c_last_name,
                                   c_preferred_cust_flag,
                                   c_birth_country,
                                   c_login,
                                   c_email_address,
                                   d_year],
                                  filter(((c_customer_sk =
                                          ws_bill_customer_sk) &&
                                         (ws_sold_date_sk = d_date_sk)),
                                    join(true,
                                      customer,
                                      join(true, web_sales, date_dim))))],
                          concat)],
                  concat)),
              select([customer_id as t_w_secyear_customer_id,
                      customer_first_name as t_w_secyear_customer_first_name,
                      customer_last_name as t_w_secyear_customer_last_name,
                      customer_preferred_cust_flag as t_w_secyear_customer_preferred_cust_flag,
                      customer_birth_country as t_w_secyear_customer_birth_country,
                      customer_login as t_w_secyear_customer_login,
                      customer_email_address as t_w_secyear_customer_email_address,
                      dyear as t_w_secyear_dyear,
                      year_total as t_w_secyear_year_total,
                      sale_type as t_w_secyear_sale_type],
                atuple([groupby([c_customer_id as customer_id,
                                 c_first_name as customer_first_name,
                                 c_last_name as customer_last_name,
                                 c_preferred_cust_flag as customer_preferred_cust_flag,
                                 c_birth_country as customer_birth_country,
                                 c_login as customer_login,
                                 c_email_address as customer_email_address,
                                 d_year as dyear,
                                 sum(((((ss_ext_list_price -
                                        ss_ext_wholesale_cost) -
                                       ss_ext_discount_amt) +
                                      ss_ext_sales_price) / 2)) as year_total,
                                 "s" as sale_type],
                          [c_customer_id,
                           c_first_name,
                           c_last_name,
                           c_preferred_cust_flag,
                           c_birth_country,
                           c_login,
                           c_email_address,
                           d_year],
                          filter(((c_customer_sk = ss_customer_sk) &&
                                 (ss_sold_date_sk = d_date_sk)),
                            join(true,
                              customer,
                              join(true, store_sales, date_dim)))),
                        atuple([groupby([c_customer_id as customer_id,
                                         c_first_name as customer_first_name,
                                         c_last_name as customer_last_name,
                                         c_preferred_cust_flag as customer_preferred_cust_flag,
                                         c_birth_country as customer_birth_country,
                                         c_login as customer_login,
                                         c_email_address as customer_email_address,
                                         d_year as dyear,
                                         sum(((((cs_ext_list_price -
                                                cs_ext_wholesale_cost) -
                                               cs_ext_discount_amt) +
                                              cs_ext_sales_price) / 2)) as year_total,
                                         "c" as sale_type],
                                  [c_customer_id,
                                   c_first_name,
                                   c_last_name,
                                   c_preferred_cust_flag,
                                   c_birth_country,
                                   c_login,
                                   c_email_address,
                                   d_year],
                                  filter(((c_customer_sk =
                                          cs_bill_customer_sk) &&
                                         (cs_sold_date_sk = d_date_sk)),
                                    join(true,
                                      customer,
                                      join(true, catalog_sales, date_dim)))),
                                groupby([c_customer_id as customer_id,
                                         c_first_name as customer_first_name,
                                         c_last_name as customer_last_name,
                                         c_preferred_cust_flag as customer_preferred_cust_flag,
                                         c_birth_country as customer_birth_country,
                                         c_login as customer_login,
                                         c_email_address as customer_email_address,
                                         d_year as dyear,
                                         sum(((((ws_ext_list_price -
                                                ws_ext_wholesale_cost) -
                                               ws_ext_discount_amt) +
                                              ws_ext_sales_price) / 2)) as year_total,
                                         "w" as sale_type],
                                  [c_customer_id,
                                   c_first_name,
                                   c_last_name,
                                   c_preferred_cust_flag,
                                   c_birth_country,
                                   c_login,
                                   c_email_address,
                                   d_year],
                                  filter(((c_customer_sk =
                                          ws_bill_customer_sk) &&
                                         (ws_sold_date_sk = d_date_sk)),
                                    join(true,
                                      customer,
                                      join(true, web_sales, date_dim))))],
                          concat)],
                  concat)))))))))

