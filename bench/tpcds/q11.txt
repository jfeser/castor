select([customer_id,
        customer_first_name,
        customer_last_name,
        customer_preferred_cust_flag],
  filter(((((((((((((((customer_id = customer_id) &&
                     (customer_id = customer_id)) &&
                    (customer_id = customer_id)) && (sale_type = "s")) &&
                  (sale_type = "w")) && (sale_type = "s")) &&
                (sale_type = "w")) && (dyear = YEAR_01)) &&
              (dyear = (YEAR_01 + 1))) && (dyear = YEAR_01)) &&
            (dyear = (YEAR_01 + 1))) && (year_total > 0)) &&
          (year_total > 0)) &&
         ((if (year_total > 0) then (year_total / year_total) else 0.0) >
         (if (year_total > 0) then (year_total / year_total) else 0.0))),
    join(true,
      filter(((c_customer_sk = ss_customer_sk) &&
             (ss_sold_date_sk = d_date_sk)),
        groupby([c_customer_id as customer_id,
                 c_first_name as customer_first_name,
                 c_last_name as customer_last_name,
                 c_preferred_cust_flag as customer_preferred_cust_flag,
                 c_birth_country as customer_birth_country,
                 c_login as customer_login,
                 c_email_address as customer_email_address,
                 d_year as dyear,
                 sum((ss_ext_list_price - ss_ext_discount_amt)) as year_total,
                 "s" as sale_type],
          [c_customer_id,
           c_first_name,
           c_last_name,
           c_preferred_cust_flag,
           c_birth_country,
           c_login,
           c_email_address,
           d_year],
          filter(((c_customer_sk = ss_customer_sk) &&
                 (ss_sold_date_sk = d_date_sk)),
            join(true, customer, join(true, store_sales, date_dim))))),
      join(true,
        filter(((c_customer_sk = ss_customer_sk) &&
               (ss_sold_date_sk = d_date_sk)),
          groupby([c_customer_id as customer_id,
                   c_first_name as customer_first_name,
                   c_last_name as customer_last_name,
                   c_preferred_cust_flag as customer_preferred_cust_flag,
                   c_birth_country as customer_birth_country,
                   c_login as customer_login,
                   c_email_address as customer_email_address,
                   d_year as dyear,
                   sum((ss_ext_list_price - ss_ext_discount_amt)) as year_total,
                   "s" as sale_type],
            [c_customer_id,
             c_first_name,
             c_last_name,
             c_preferred_cust_flag,
             c_birth_country,
             c_login,
             c_email_address,
             d_year],
            filter(((c_customer_sk = ss_customer_sk) &&
                   (ss_sold_date_sk = d_date_sk)),
              join(true, customer, join(true, store_sales, date_dim))))),
        join(true,
          filter(((c_customer_sk = ss_customer_sk) &&
                 (ss_sold_date_sk = d_date_sk)),
            groupby([c_customer_id as customer_id,
                     c_first_name as customer_first_name,
                     c_last_name as customer_last_name,
                     c_preferred_cust_flag as customer_preferred_cust_flag,
                     c_birth_country as customer_birth_country,
                     c_login as customer_login,
                     c_email_address as customer_email_address,
                     d_year as dyear,
                     sum((ss_ext_list_price - ss_ext_discount_amt)) as year_total,
                     "s" as sale_type],
              [c_customer_id,
               c_first_name,
               c_last_name,
               c_preferred_cust_flag,
               c_birth_country,
               c_login,
               c_email_address,
               d_year],
              filter(((c_customer_sk = ss_customer_sk) &&
                     (ss_sold_date_sk = d_date_sk)),
                join(true, customer, join(true, store_sales, date_dim))))),
          filter(((c_customer_sk = ss_customer_sk) &&
                 (ss_sold_date_sk = d_date_sk)),
            groupby([c_customer_id as customer_id,
                     c_first_name as customer_first_name,
                     c_last_name as customer_last_name,
                     c_preferred_cust_flag as customer_preferred_cust_flag,
                     c_birth_country as customer_birth_country,
                     c_login as customer_login,
                     c_email_address as customer_email_address,
                     d_year as dyear,
                     sum((ss_ext_list_price - ss_ext_discount_amt)) as year_total,
                     "s" as sale_type],
              [c_customer_id,
               c_first_name,
               c_last_name,
               c_preferred_cust_flag,
               c_birth_country,
               c_login,
               c_email_address,
               d_year],
              filter(((c_customer_sk = ss_customer_sk) &&
                     (ss_sold_date_sk = d_date_sk)),
                join(true, customer, join(true, store_sales, date_dim))))))))))

