select([n1_name, n2_name, l_year, revenue],
   alist(orderby([n1_name, n2_name, l_year],
           dedup(
             select([n1_name, n2_name, to_year(l_shipdate) as l_year],
               join(((s_suppkey = l_suppkey) && true),
                 join((o_orderkey = l_orderkey),
                   join((c_custkey = o_custkey),
                     join((c_nationkey = n2_nationkey),
                       select([n_name as n2_name, n_nationkey as n2_nationkey], nation),
                       customer),
                     orders),
                   filter(((l_shipdate >= date("1995-01-01")) && (l_shipdate <= date("1996-12-31"))), lineitem)),
                 join((s_nationkey = n1_nationkey),
                   select([n_name as n1_name, n_nationkey as n1_nationkey], nation),
                   supplier))))) as k0,
     select([n1_name, n2_name, l_year, revenue],
       ahashidx(dedup(
                  atuple([dedup(
                            atuple([select([n_name as x27], dedup(select([n_name], nation))),
                                    select([n_name as x27], dedup(select([n_name], nation)))],
                              concat)),
                          dedup(
                            atuple([select([n_name as x30], dedup(select([n_name], nation))),
                                    select([n_name as x30], dedup(select([n_name], nation)))],
                              concat))],
                    cross)) as s7,
         alist(filter((count0 > 0),
                 select([count() as count0, n1_name, n2_name, to_year(l_shipdate) as l_year,
                         sum((l_extendedprice * (1 - l_discount))) as revenue],
                   atuple([ascalar(s7.x27), ascalar(s7.x30),
                           alist(filter((true && (n2_name = k0.n2_name)),
                                   select([n_name as n2_name, n_nationkey as n2_nationkey], nation)) as s4,
                             filter((((n1_name = s7.x27) && (n2_name = s7.x30)) ||
                                    ((n1_name = s7.x30) && (n2_name = s7.x27))),
                               atuple([ascalar(s4.n2_name),
                                       alist(select([l_suppkey, l_shipdate, l_discount, l_extendedprice],
                                               filter(((to_year(l_shipdate) = k0.l_year) &&
                                                      (c_nationkey = s4.n2_nationkey)),
                                                 select([l_suppkey, l_shipdate,
                                                         l_discount,
                                                         l_extendedprice,
                                                         c_nationkey],
                                                   join((c_custkey = o_custkey),
                                                     join((o_orderkey = l_orderkey),
                                                       filter(((l_shipdate >= date("1995-01-01")) &&
                                                              (l_shipdate <= date("1996-12-31"))),
                                                         lineitem),
                                                       orders),
                                                     customer)))) as s3,
                                         atuple([atuple([ascalar(s3.l_shipdate),
                                                         ascalar(s3.l_discount),
                                                         ascalar(s3.l_extendedprice)],
                                                   cross),
                                                 alist(select([n1_name],
                                                         join((((n1_name = k0.n1_name) && (s_suppkey = s3.l_suppkey))
                                                              && (s_nationkey = n1_nationkey)),
                                                           select([n_name as n1_name, n_nationkey as n1_nationkey],
                                                             nation),
                                                           supplier)) as s2,
                                                   ascalar(s2.n1_name))],
                                           cross))],
                                 cross)))],
                     cross))) as s8,
           atuple([ascalar(s8.count0), ascalar(s8.n1_name), ascalar(s8.n2_name),
                   ascalar(s8.l_year), ascalar(s8.revenue)],
      cross)),
         ("", "")))))
